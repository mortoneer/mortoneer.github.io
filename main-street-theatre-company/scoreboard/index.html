<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HSM Scoreboard</title>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --card-bg: #2d2d2d;
            --text-color: #e0e0e0;
            --accent-color: #ffcc00;
            --highlight-color: #2ecc71;
            --error-color: #e74c3c;
            --input-bg: #444;
        }

        body {
            font-family: 'Courier New', Courier, monospace;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding-bottom: 140px;
        }

        /* --- HEADER & CONNECTION PANEL --- */
        header {
            background-color: #000;
            padding: 15px;
            border-bottom: 2px solid var(--accent-color);
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .connection-panel {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
            background: #222;
            padding: 10px;
            border-radius: 6px;
        }

        .device-select {
            background-color: var(--accent-color);
            color: #000;
            font-weight: bold;
            border: none;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
        }

        input {
            background: var(--input-bg);
            border: 1px solid #666;
            color: white;
            padding: 8px;
            font-family: inherit;
            border-radius: 4px;
            width: 140px;
            font-size: 0.85rem;
        }

        .btn-conn {
            padding: 8px 15px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 4px;
            border: none;
        }
        .btn-connect { background-color: var(--highlight-color); color: #000; }
        .btn-disconnect { background-color: var(--error-color); color: #fff; opacity: 0.5; pointer-events: none;}
        
        .status-dot {
            height: 12px; width: 12px; 
            background-color: #555; 
            border-radius: 50%; 
            display: inline-block;
        }
        .status-dot.connected { background-color: var(--highlight-color); box-shadow: 0 0 8px var(--highlight-color); }

        /* --- SCENE LIST --- */
        #scene-container {
            max-width: 800px;
            margin: 20px auto;
            padding: 0 10px;
        }

        .scene-card {
            background-color: var(--card-bg);
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 8px;
            border-left: 5px solid #555;
            opacity: 0.5;
            transition: all 0.3s ease;
        }

        .scene-card.active {
            opacity: 1;
            transform: scale(1.02);
            border-left: 8px solid var(--highlight-color);
            background-color: #383838;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
        }

        .scene-header {
            font-weight: bold;
            color: var(--accent-color);
            border-bottom: 1px solid #444;
            padding-bottom: 5px;
            margin-bottom: 5px;
            display: flex; justify-content: space-between;
        }

        /* --- VISUAL MODES --- */
        .visual-summary {
            padding: 10px; border-radius: 4px; margin-top: 10px; min-height: 80px;
        }
        
        /* Mode 0: Game */
        .visual-summary.mode-0 { display: flex; justify-content: space-around; align-items: center; background: #222; }
        .score-val { font-size: 1.5rem; font-weight: bold; color: #fff; }
        .clock-val { font-size: 1.5rem; font-weight: bold; color: var(--accent-color); border: 2px solid #555; padding: 5px 10px; border-radius: 5px;}
        
        /* Mode 1: Victory */
        .visual-summary.mode-1 { background: linear-gradient(135deg, #2c3e50, #c0392b); flex-direction: column; justify-content: center; text-align: center; border: 2px solid #e74c3c; animation: pulse 2s infinite; }
        .victory-text { font-size: 1.2rem; font-weight: bold; color: #fff; text-shadow: 0 0 10px #f1c40f; }

        /* Mode 2: Clock */
        .visual-summary.mode-2 { background: #000; display: flex; justify-content: center; align-items: center; }
        .visual-summary.mode-2 .clock-val { font-size: 2.5rem; border: none; color: #fff; }

        /* Mode 4: OFF */
        .visual-summary.mode-4 { background: #000; display: flex; justify-content: center; align-items: center; border: 1px dashed #444; }
        .offline-text { color: #333; font-family: monospace; font-weight: bold; letter-spacing: 2px; }

        .json-block { background: #111; padding: 10px; border-radius: 4px; font-size: 0.75rem; overflow-x: auto; border: 1px solid #333; margin: 0; }

        /* --- CONTROLS FOOTER --- */
        #controls {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background-color: #000; padding: 15px;
            display: flex; justify-content: center; gap: 20px;
            border-top: 2px solid #444; z-index: 1000;
        }
        .btn-nav { padding: 12px 30px; font-size: 1.2rem; font-weight: bold; cursor: pointer; border-radius: 5px; border: none; }
        #btn-prev { background-color: #555; color: white; }
        #btn-next { background-color: var(--highlight-color); color: black; }

        /* --- LOG BOX --- */
        #log-box {
            position: fixed; bottom: 90px; right: 10px;
            width: 300px; height: 150px;
            background: rgba(0,0,0,0.9);
            border: 1px solid #555;
            color: #0f0;
            font-size: 10px;
            overflow-y: auto;
            padding: 5px;
            z-index: 2000;
            font-family: monospace;
            display: flex; flex-direction: column-reverse; 
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); }
            100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
        }
    </style>
</head>
<body>

<header>
    <div style="font-size: 1.5rem; font-weight: bold;">HSM SCENE 10</div>
    
    <div class="connection-panel">
        <span id="connection-status" class="status-dot"></span>
        
        <select id="targetDevice" class="device-select" onchange="updateTargetDevice()">
            <option value="scoreboard">Main Scoreboard</option>
            <option value="onAirSign">On Air Sign</option>
        </select>

        <label>MAC: <input type="text" id="macAddressInput" readonly></label>
        <label>Event: <input type="text" id="eventTypeInput" readonly></label>
        
        <button id="btnConnect" class="btn-conn btn-connect" onclick="connectSerial()">Connect Serial</button>
        <button id="btnDisconnect" class="btn-conn btn-disconnect" onclick="disconnectSerial()">Disconnect</button>
    </div>
</header>

<div id="scene-container"></div>

<div id="log-box"></div>

<div id="controls">
    <button id="btn-prev" class="btn-nav" onclick="prevScene()">&#8592; PREV</button>
    <button id="btn-next" class="btn-nav" onclick="nextScene()">NEXT (Space) &#8594;</button>
</div>

<script>
    // --- 1. CONFIGURATION & DATA ---
    const ScoreboardMode = { BASKET_BALL_GAME: 0, FIREWORKS_DISPLAY: 1, CLOCK_ONLY: 2, COUNTDOWN: 3, OFF: 4 };

    const scenes = [
        {"description": "Show Start. OFF", "data":{"homeScore":0,"awayScore":0,"homeFouls":0,"awayFouls":0,"quarter":0,"clockMinutes":0,"clockSeconds":0,"mode":4,"clockRunning":false},"index":0},
        {"description": "New Years Count Down", "data":{"homeScore":0,"awayScore":0,"homeFouls":0,"awayFouls":0,"quarter":0,"clockMinutes":0,"clockSeconds":10,"mode":2,"clockRunning":false},"index":1},
        {"description": "NINE", "data":{"homeScore":0,"awayScore":0,"homeFouls":0,"awayFouls":0,"quarter":0,"clockMinutes":0,"clockSeconds":9,"mode":2,"clockRunning":false},"index":2},
        {"description": "EIGHT", "data":{"homeScore":0,"awayScore":0,"homeFouls":0,"awayFouls":0,"quarter":0,"clockMinutes":0,"clockSeconds":8,"mode":2,"clockRunning":false},"index":3},
        {"description": "SEVEN", "data":{"homeScore":0,"awayScore":0,"homeFouls":0,"awayFouls":0,"quarter":0,"clockMinutes":0,"clockSeconds":7,"mode":2,"clockRunning":false},"index":4},
        {"description": "SIX", "data":{"homeScore":0,"awayScore":0,"homeFouls":0,"awayFouls":0,"quarter":0,"clockMinutes":0,"clockSeconds":6,"mode":2,"clockRunning":false},"index":5},
        {"description": "FIVE", "data":{"homeScore":0,"awayScore":0,"homeFouls":0,"awayFouls":0,"quarter":0,"clockMinutes":0,"clockSeconds":5,"mode":2,"clockRunning":false},"index":6},
        {"description": "FOUR", "data":{"homeScore":0,"awayScore":0,"homeFouls":0,"awayFouls":0,"quarter":0,"clockMinutes":0,"clockSeconds":4,"mode":2,"clockRunning":false},"index":7},
        {"description": "THREE", "data":{"homeScore":0,"awayScore":0,"homeFouls":0,"awayFouls":0,"quarter":0,"clockMinutes":0,"clockSeconds":3,"mode":2,"clockRunning":false},"index":8},
        {"description": "TWO", "data":{"homeScore":0,"awayScore":0,"homeFouls":0,"awayFouls":0,"quarter":0,"clockMinutes":0,"clockSeconds":2,"mode":2,"clockRunning":false},"index":9},
        {"description": "ONE", "data":{"homeScore":0,"awayScore":0,"homeFouls":0,"awayFouls":0,"quarter":0,"clockMinutes":0,"clockSeconds":1,"mode":2,"clockRunning":false},"index":10},
        {"description": "Fireworks", "data":{"homeScore":0,"awayScore":0,"homeFouls":0,"awayFouls":0,"quarter":0,"clockMinutes":0,"clockSeconds":0,"mode":1,"clockRunning":false},"index":11},
        {"description": "Off", "data":{"homeScore":0,"awayScore":0,"homeFouls":0,"awayFouls":0,"quarter":0,"clockMinutes":0,"clockSeconds":0,"mode":4,"clockRunning":false},"index":12},
        {"description": "13. Act 1 Scene 4 - Get Your Head In The Game - 2:30 minutes at practice", "data":{"homeScore":0,"awayScore":0,"homeFouls":0,"awayFouls":0,"quarter":0,"clockMinutes":2,"clockSeconds":30,"mode":2,"clockRunning":true},"index":13},
        {"description": "OFF", "data":{"homeScore":0,"awayScore":0,"homeFouls":0,"awayFouls":0,"quarter":0,"clockMinutes":0,"clockSeconds":0,"mode":4,"clockRunning":false},"index":14},
        {"description": "15. Act 2 Scene 4 - Game Board Reset", "data":{"homeScore":0,"awayScore":0,"homeFouls":0,"awayFouls":0,"quarter":1,"clockMinutes":8,"clockSeconds":0,"mode":0,"clockRunning":false},"index":15},
        {"description": "OFF", "data":{"homeScore":0,"awayScore":0,"homeFouls":0,"awayFouls":0,"quarter":0,"clockMinutes":0,"clockSeconds":0,"mode":4,"clockRunning":false},"index":16},

        // GAME
        { description: "Start: Tip Off", data: {"homeScore":0,"awayScore":0,"homeFouls":0,"awayFouls":0,"quarter":1,"clockMinutes":8,"clockSeconds":0,"mode": 0,"clockRunning":true} },
        { description: "End Q1: Wildcats Lead", data: {"homeScore":18,"awayScore":14,"homeFouls":1,"awayFouls":2,"quarter":2,"clockMinutes":8,"clockSeconds":0,"mode": 0,"clockRunning":true} },
        { description: "Halftime: West High Leads", data: {"homeScore":32,"awayScore":38,"homeFouls":3,"awayFouls":2,"quarter":3,"clockMinutes":8,"clockSeconds":0,"mode": 0,"clockRunning":true} },
        { description: "End Q3: Gap Widens", data: {"homeScore":48,"awayScore":55,"homeFouls":4,"awayFouls":3,"quarter":4,"clockMinutes":8,"clockSeconds":0,"mode": 0,"clockRunning":true} },
        { description: "Mid Q4: Comeback Begins", data: {"homeScore":60,"awayScore":64,"homeFouls":4,"awayFouls":4,"quarter":4,"clockMinutes":3,"clockSeconds":45,"mode": 0,"clockRunning":true} },
        { description: "Pre-Song: Down by 2", data: {"homeScore":66,"awayScore":68,"homeFouls":4,"awayFouls":4,"quarter":4,"clockMinutes":1,"clockSeconds":30,"mode": 0,"clockRunning":true} },
        
        // POWER OUTAGE
        { description: "BLACKOUT (Power Outage)", data: {"homeScore":66,"awayScore":68,"homeFouls":4,"awayFouls":4,"quarter":4,"clockMinutes":1,"clockSeconds":30,"mode": 4,"clockRunning":false} },
        
        // RESUME
        { description: "Lights Up: 5 Sec Left", data: {"homeScore":74,"awayScore":76,"homeFouls":5,"awayFouls":5,"quarter":4,"clockMinutes":0,"clockSeconds":5,"mode": 0,"clockRunning":false} },
        { description: "Manual Count: 4", data: {"homeScore":74,"awayScore":76,"homeFouls":5,"awayFouls":5,"quarter":4,"clockMinutes":0,"clockSeconds":4,"mode": 0,"clockRunning":false} },
        { description: "Manual Count: 3", data: {"homeScore":74,"awayScore":76,"homeFouls":5,"awayFouls":5,"quarter":4,"clockMinutes":0,"clockSeconds":3,"mode": 0,"clockRunning":false} },
        { description: "Manual Count: 2", data: {"homeScore":74,"awayScore":76,"homeFouls":5,"awayFouls":5,"quarter":4,"clockMinutes":0,"clockSeconds":2,"mode": 0,"clockRunning":false} },
        { description: "Manual Count: 1", data: {"homeScore":74,"awayScore":76,"homeFouls":5,"awayFouls":5,"quarter":4,"clockMinutes":0,"clockSeconds":1,"mode": 0,"clockRunning":false} },
        { description: "BUZZER: Wildcats Win!", data: {"homeScore":77,"awayScore":76,"homeFouls":5,"awayFouls":5,"quarter":4,"clockMinutes":0,"clockSeconds":0,"mode": 0,"clockRunning":false} },
        
        // VICTORY
        { description: "VICTORY CELEBRATION", data: {"homeScore":77,"awayScore":76,"homeFouls":5,"awayFouls":5,"quarter":4,"clockMinutes":0,"clockSeconds":0,"mode": 1,"clockRunning":false} },
    ];

    // --- 2. DEVICE SELECTION LOGIC ---
    function updateTargetDevice() {
        const targetId = document.getElementById('targetDevice').value;
        const macInput = document.getElementById('macAddressInput');
        const evtInput = document.getElementById('eventTypeInput');

        if (targetId === 'onAirSign') {
            macInput.value = '8c:4f:00:3c:dd:2c';
            evtInput.value = 'ON_AIR_SIGN';
        } else {
            // Default: Scoreboard
            macInput.value = '94:51:dc:32:a3:b0';
            evtInput.value = 'SCOREBOARD';
        }
    }

    // --- 3. SERIAL PORT VARIABLES ---
    let port;
    let reader;
    let writer;
    let keepReading = false;
    const MAX_LOG_LINES = 50;
    let lineBuffer = '';

    // --- 4. SERIAL LOGIC ---

    async function connectSerial() {
        if (!('serial' in navigator)) {
            alert('Web Serial API not supported. Use Chrome or Edge.');
            return;
        }
        try {
            port = await navigator.serial.requestPort();
            await port.open({ baudRate: 115200 });
            
            log('Port Connected');
            updateConnectionUI(true);
            keepReading = true;
            readUntilClosed();
        } catch (error) {
            log('Connect Error: ' + error.message, true);
        }
    }

    async function disconnectSerial() {
        keepReading = false;
        if (reader) {
            try {
                await reader.cancel();
            } catch (error) { console.error(error); }
        }
        if (port) {
            try {
                await port.close();
            } catch(e) { console.error(e); }
            port = null;
        }
        updateConnectionUI(false);
        log('Port Disconnected');
    }

    async function readUntilClosed() {
        const textDecoder = new TextDecoder();
        while (port.readable && keepReading) {
            reader = port.readable.getReader();
            try {
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    
                    lineBuffer += textDecoder.decode(value);
                    let newlineIndex;
                    while ((newlineIndex = lineBuffer.indexOf('\n')) !== -1) {
                        const line = lineBuffer.slice(0, newlineIndex).trim();
                        lineBuffer = lineBuffer.slice(newlineIndex + 1);
                        if (line) log('RX: ' + line);
                    }
                }
            } catch (error) {
                log('Read Error: ' + error.message, true);
                if (error.message.includes("device has been lost")) disconnectSerial();
            } finally {
                reader.releaseLock();
            }
        }
    }

    async function sendCommand(command, data) {
        if (!port || !port.writable) {
            log('TX Failed: Not Connected', true);
            return;
        }

        writer = port.writable.getWriter();
        const macAddress = document.getElementById('macAddressInput').value;
        const eventType = document.getElementById('eventTypeInput').value;

        // Protocol: RELAY | MAC | EVENT | COMMAND | DATA
        let message = `RELAY|${macAddress}|${eventType}|${command}`;
        if (data !== undefined && data !== null && data !== '') {
            message += `|${data}`;
        }
        message += '\n';

        const textEncoder = new TextEncoder();
        try {
            await writer.write(textEncoder.encode(message));
            log('TX: ' + command);
        } catch (error) {
            log('TX Error: ' + error.message, true);
        } finally {
            writer.releaseLock();
        }
    }

    function updateConnectionUI(isConnected) {
        const dot = document.getElementById('connection-status');
        const btnCon = document.getElementById('btnConnect');
        const btnDis = document.getElementById('btnDisconnect');

        if(isConnected) {
            dot.classList.add('connected');
            btnCon.style.opacity = '0.5'; btnCon.style.pointerEvents = 'none';
            btnDis.style.opacity = '1'; btnDis.style.pointerEvents = 'auto';
        } else {
            dot.classList.remove('connected');
            btnCon.style.opacity = '1'; btnCon.style.pointerEvents = 'auto';
            btnDis.style.opacity = '0.5'; btnDis.style.pointerEvents = 'none';
        }
    }

    function log(msg, isError = false) {
        const box = document.getElementById('log-box');
        const line = document.createElement('div');
        line.textContent = `> ${msg}`;
        if(isError) line.style.color = '#e74c3c';
        box.prepend(line);
        if(box.children.length > MAX_LOG_LINES) {
            box.removeChild(box.lastChild);
        }
    }

    // --- 5. SCENE CONTROLLER LOGIC ---
    let currentIndex = -1;
    const container = document.getElementById('scene-container');

    function init() {
        scenes.forEach((scene, index) => {
            const el = document.createElement('div');
            el.className = `scene-card mode-${scene.data.mode}`;
            el.id = `scene-${index}`;
            const timeStr = `${scene.data.clockMinutes}:${scene.data.clockSeconds.toString().padStart(2, '0')}`;
            const modeName = Object.keys(ScoreboardMode).find(key => ScoreboardMode[key] === scene.data.mode);

            // Visual HTML Generation
            let visualHtml = '';
            switch (scene.data.mode) {
                case 4: // OFF
                    visualHtml = `<div class="visual-summary mode-4"><div class="offline-text">/// SYSTEM OFFLINE ///</div></div>`;
                    break;
                case 1: // FIREWORKS
                    visualHtml = `<div class="visual-summary mode-1"><div class="victory-text">ðŸŽ‰ WILDCATS WIN! ðŸŽ‰</div><div style="color:white;">${scene.data.homeScore} - ${scene.data.awayScore}</div></div>`;
                    break;
                case 2: // CLOCK ONLY
                    visualHtml = `<div class="visual-summary mode-2"><div class="clock-val">${timeStr}</div></div>`;
                    break;
                default: // GAME
                    visualHtml = `<div class="visual-summary mode-0">
                        <div style="text-align:center"><div style="font-size:0.7rem; color:#888;">HOME</div><div class="score-val" style="color:#ffcc00">${scene.data.homeScore}</div></div>
                        <div style="text-align:center"><div class="clock-val">${timeStr}</div><div style="font-size:0.7rem; color:#666;">Q${scene.data.quarter}</div></div>
                        <div style="text-align:center"><div style="font-size:0.7rem; color:#888;">AWAY</div><div class="score-val" style="color:#ff4444">${scene.data.awayScore}</div></div>
                    </div>`;
                    break;
            }

            el.innerHTML = `
                <div class="scene-header"><span>CUE #${index + 1}: ${scene.description}</span><span style="font-size:0.7rem; background:#444; padding:2px 4px;">${modeName}</span></div>
                <div class="data-display"><pre class="json-block">${JSON.stringify(scene.data, null, 2)}</pre>${visualHtml}</div>
            `;
            container.appendChild(el);
        });
        
        // Initial UI State
        updateTargetDevice(); // Set initial MAC/Event values
        updateConnectionUI(false);
    }

    function updateUI() {
        document.querySelectorAll('.scene-card').forEach(el => el.classList.remove('active'));
        if (currentIndex >= 0 && currentIndex < scenes.length) {
            const activeEl = document.getElementById(`scene-${currentIndex}`);
            if (activeEl) {
                activeEl.classList.add('active');
                activeEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                onSceneChange(scenes[currentIndex].data);
            }
        }
    }

    function nextScene() {
        if (currentIndex < scenes.length - 1) { currentIndex++; updateUI(); }
    }
    function prevScene() {
        if (currentIndex > 0) { currentIndex--; updateUI(); }
    }

    document.addEventListener('keydown', (e) => {
        if (e.code === "Space" || e.code === "ArrowRight") { e.preventDefault(); nextScene(); } 
        else if (e.code === "ArrowLeft") { prevScene(); }
    });

    // --- 6. TRIGGER LOGIC ---
    function onSceneChange(newScene) {
        // Construct the JSON payload for the scoreboard
        const jsonPayload = JSON.stringify({ scene: newScene, index: -1 });
        
        // Send command via Serial
        sendCommand('SET_SCENE_FROM_JSON', jsonPayload);
    }

    init();

</script>
</body>
</html>
